{"version":3,"sources":["index.js"],"names":["h","require","UIPlugin","getFileTypeExtension","mimeTypes","canvasToBlob","supportsMediaRecorder","CameraIcon","CameraScreen","PermissionsScreen","toMimeType","fileType","slice","isVideoMimeType","mimeType","test","isImageMimeType","getMediaDevices","navigator","mediaDevices","module","exports","Webcam","constructor","uppy","opts","supportsUserMedia","protocol","location","match","id","type","capturedMediaFile","icon","defaultLocale","strings","pluginNameCamera","smile","takePicture","startRecording","stopRecording","allowAccessTitle","allowAccessDescription","noCameraTitle","noCameraDescription","recordingStoppedMaxSize","recordingLength","submitRecordedFile","discardRecordedFile","defaultOptions","onBeforeSnapshot","Promise","resolve","countdown","modes","mirror","showVideoSourceDropdown","facingMode","preferredImageMimeType","preferredVideoMimeType","showRecordingLength","i18nInit","title","i18n","install","bind","setPluginState","render","start","stop","takeSnapshot","discardRecordedVideo","submit","oneTwoThreeSmile","focus","changeVideoSource","webcamActive","hasCamera","cameraReady","cameraError","recordingLengthSeconds","videoSources","currentDeviceId","setOptions","newOpts","videoConstraints","hasCameraCheck","enumerateDevices","then","devices","some","device","kind","isAudioOnly","length","getConstraints","deviceId","acceptsAudio","indexOf","acceptsVideo","audio","video","options","reject","Error","constraints","getUserMedia","stream","tracks","getAudioTracks","getVideoTracks","getSettings","forEach","track","updateVideoSources","catch","err","info","message","getMediaRecorderOptions","MediaRecorder","isTypeSupported","restrictions","preferredVideoMimeTypes","allowedFileTypes","map","filter","filterSupportedTypes","candidateType","acceptableMimeTypes","recorder","recordingChunks","stoppingBecauseOfMaxSize","addEventListener","event","push","data","maxFileSize","totalSize","reduce","acc","chunk","size","averageChunkSize","expectedEndChunkSize","maxSize","Math","max","recordingLengthTimer","setInterval","currentRecordingLength","getPluginState","isRecording","stopped","clearInterval","getVideo","file","recordedVideo","URL","createObjectURL","isRestriction","log","error","addFile","audioTracks","videoTracks","concat","once","getVideoElement","el","querySelector","count","countDown","captureInProgress","setTimeout","getImage","tagFile","width","videoWidth","height","videoHeight","canvas","document","createElement","ctx","getContext","drawImage","preferredImageMimeTypes","ext","name","Date","now","blob","source","Blob","find","fileExtension","webcamState","target","mount","ondevicechange","restartStream","videoSource","uninstall","unmount","onUnmount","VERSION"],"mappings":"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","sourcesContent":["const { h } = require('preact')\nconst { UIPlugin } = require('@uppy/core')\nconst getFileTypeExtension = require('@uppy/utils/lib/getFileTypeExtension')\nconst mimeTypes = require('@uppy/utils/lib/mimeTypes')\nconst canvasToBlob = require('@uppy/utils/lib/canvasToBlob')\nconst supportsMediaRecorder = require('./supportsMediaRecorder')\nconst CameraIcon = require('./CameraIcon')\nconst CameraScreen = require('./CameraScreen')\nconst PermissionsScreen = require('./PermissionsScreen')\n\n/**\n * Normalize a MIME type or file extension into a MIME type.\n *\n * @param {string} fileType - MIME type or a file extension prefixed with `.`.\n * @returns {string|undefined} The MIME type or `undefined` if the fileType is an extension and is not known.\n */\nfunction toMimeType (fileType) {\n  if (fileType[0] === '.') {\n    return mimeTypes[fileType.slice(1)]\n  }\n  return fileType\n}\n\n/**\n * Is this MIME type a video?\n *\n * @param {string} mimeType - MIME type.\n * @returns {boolean}\n */\nfunction isVideoMimeType (mimeType) {\n  return /^video\\/[^*]+$/.test(mimeType)\n}\n\n/**\n * Is this MIME type an image?\n *\n * @param {string} mimeType - MIME type.\n * @returns {boolean}\n */\nfunction isImageMimeType (mimeType) {\n  return /^image\\/[^*]+$/.test(mimeType)\n}\n\nfunction getMediaDevices () {\n  // bug in the compatibility data\n  // eslint-disable-next-line compat/compat\n  return navigator.mediaDevices\n}\n/**\n * Webcam\n */\nmodule.exports = class Webcam extends UIPlugin {\n  // eslint-disable-next-line global-require\n  static VERSION = require('../package.json').version\n\n  // enableMirror is used to toggle mirroring, for instance when discarding the video,\n  // while `opts.mirror` is used to remember the initial user setting\n  #enableMirror\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.mediaDevices = getMediaDevices()\n    this.supportsUserMedia = !!this.mediaDevices\n    // eslint-disable-next-line no-restricted-globals\n    this.protocol = location.protocol.match(/https/i) ? 'https' : 'http'\n    this.id = this.opts.id || 'Webcam'\n    this.type = 'acquirer'\n    this.capturedMediaFile = null\n    this.icon = () => (\n      <svg aria-hidden=\"true\" focusable=\"false\" width=\"32\" height=\"32\" viewBox=\"0 0 32 32\">\n        <g fill=\"none\" fillRule=\"evenodd\">\n          <rect className=\"uppy-ProviderIconBg\" fill=\"#03BFEF\" width=\"32\" height=\"32\" rx=\"16\" />\n          <path d=\"M22 11c1.133 0 2 .867 2 2v7.333c0 1.134-.867 2-2 2H10c-1.133 0-2-.866-2-2V13c0-1.133.867-2 2-2h2.333l1.134-1.733C13.6 9.133 13.8 9 14 9h4c.2 0 .4.133.533.267L19.667 11H22zm-6 1.533a3.764 3.764 0 0 0-3.8 3.8c0 2.129 1.672 3.801 3.8 3.801s3.8-1.672 3.8-3.8c0-2.13-1.672-3.801-3.8-3.801zm0 6.261c-1.395 0-2.46-1.066-2.46-2.46 0-1.395 1.065-2.461 2.46-2.461s2.46 1.066 2.46 2.46c0 1.395-1.065 2.461-2.46 2.461z\" fill=\"#FFF\" fillRule=\"nonzero\" />\n        </g>\n      </svg>\n    )\n\n    this.defaultLocale = {\n      strings: {\n        pluginNameCamera: 'Camera',\n        smile: 'Smile!',\n        takePicture: 'Take a picture',\n        startRecording: 'Begin video recording',\n        stopRecording: 'Stop video recording',\n        allowAccessTitle: 'Please allow access to your camera',\n        allowAccessDescription: 'In order to take pictures or record video with your camera, please allow camera access for this site.',\n        noCameraTitle: 'Camera Not Available',\n        noCameraDescription: 'In order to take pictures or record video, please connect a camera device',\n        recordingStoppedMaxSize: 'Recording stopped because the file size is about to exceed the limit',\n        recordingLength: 'Recording length %{recording_length}',\n        submitRecordedFile: 'Submit recorded file',\n        discardRecordedFile: 'Discard recorded file',\n      },\n    }\n\n    // set default options\n    const defaultOptions = {\n      onBeforeSnapshot: () => Promise.resolve(),\n      countdown: false,\n      modes: [\n        'video-audio',\n        'video-only',\n        'audio-only',\n        'picture',\n      ],\n      mirror: true,\n      showVideoSourceDropdown: false,\n      facingMode: 'user',\n      preferredImageMimeType: null,\n      preferredVideoMimeType: null,\n      showRecordingLength: false,\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n    this.i18nInit()\n    this.title = this.i18n('pluginNameCamera')\n\n    this.#enableMirror = this.opts.mirror\n\n    this.install = this.install.bind(this)\n    this.setPluginState = this.setPluginState.bind(this)\n    this.render = this.render.bind(this)\n\n    // Camera controls\n    this.start = this.start.bind(this)\n    this.stop = this.stop.bind(this)\n    this.takeSnapshot = this.takeSnapshot.bind(this)\n    this.startRecording = this.startRecording.bind(this)\n    this.stopRecording = this.stopRecording.bind(this)\n    this.discardRecordedVideo = this.discardRecordedVideo.bind(this)\n    this.submit = this.submit.bind(this)\n    this.oneTwoThreeSmile = this.oneTwoThreeSmile.bind(this)\n    this.focus = this.focus.bind(this)\n    this.changeVideoSource = this.changeVideoSource.bind(this)\n\n    this.webcamActive = false\n\n    if (this.opts.countdown) {\n      this.opts.onBeforeSnapshot = this.oneTwoThreeSmile\n    }\n\n    this.setPluginState({\n      hasCamera: false,\n      cameraReady: false,\n      cameraError: null,\n      recordingLengthSeconds: 0,\n      videoSources: [],\n      currentDeviceId: null,\n    })\n  }\n\n  setOptions (newOpts) {\n    super.setOptions({\n      ...newOpts,\n      videoConstraints: {\n        // May be undefined but ... handles that\n        ...this.opts.videoConstraints,\n        ...newOpts?.videoConstraints,\n      },\n    })\n  }\n\n  hasCameraCheck () {\n    if (!this.mediaDevices) {\n      return Promise.resolve(false)\n    }\n\n    return this.mediaDevices.enumerateDevices().then(devices => {\n      return devices.some(device => device.kind === 'videoinput')\n    })\n  }\n\n  isAudioOnly () {\n    return this.opts.modes.length === 1 && this.opts.modes[0] === 'audio-only'\n  }\n\n  getConstraints (deviceId = null) {\n    const acceptsAudio = this.opts.modes.indexOf('video-audio') !== -1\n      || this.opts.modes.indexOf('audio-only') !== -1\n    const acceptsVideo = !this.isAudioOnly()\n        && (this.opts.modes.indexOf('video-audio') !== -1\n          || this.opts.modes.indexOf('video-only') !== -1\n          || this.opts.modes.indexOf('picture') !== -1)\n\n    const videoConstraints = {\n      ...(this.opts.videoConstraints || { facingMode: this.opts.facingMode }),\n      // facingMode takes precedence over deviceId, and not needed\n      // when specific device is selected\n      ...(deviceId ? { deviceId, facingMode: null } : {}),\n    }\n\n    return {\n      audio: acceptsAudio,\n      video: acceptsVideo ? videoConstraints : false,\n    }\n  }\n\n  // eslint-disable-next-line consistent-return\n  start (options = null) {\n    if (!this.supportsUserMedia) {\n      return Promise.reject(new Error('Webcam access not supported'))\n    }\n\n    this.webcamActive = true\n\n    if (this.opts.mirror) {\n      this.#enableMirror = true\n    }\n\n    const constraints = this.getConstraints(options && options.deviceId ? options.deviceId : null)\n\n    this.hasCameraCheck().then(hasCamera => {\n      this.setPluginState({\n        hasCamera,\n      })\n\n      // ask user for access to their camera\n      return this.mediaDevices.getUserMedia(constraints)\n        .then((stream) => {\n          this.stream = stream\n\n          let currentDeviceId = null\n          const tracks = this.isAudioOnly() ? stream.getAudioTracks() : stream.getVideoTracks()\n\n          if (!options || !options.deviceId) {\n            currentDeviceId = tracks[0].getSettings().deviceId\n          } else {\n            tracks.forEach((track) => {\n              if (track.getSettings().deviceId === options.deviceId) {\n                currentDeviceId = track.getSettings().deviceId\n              }\n            })\n          }\n\n          // Update the sources now, so we can access the names.\n          this.updateVideoSources()\n\n          this.setPluginState({\n            currentDeviceId,\n            cameraReady: true,\n          })\n        })\n        .catch((err) => {\n          this.setPluginState({\n            cameraReady: false,\n            cameraError: err,\n          })\n          this.uppy.info(err.message, 'error')\n        })\n    })\n  }\n\n  /**\n   * @returns {object}\n   */\n  getMediaRecorderOptions () {\n    const options = {}\n\n    // Try to use the `opts.preferredVideoMimeType` or one of the `allowedFileTypes` for the recording.\n    // If the browser doesn't support it, we'll fall back to the browser default instead.\n    // Safari doesn't have the `isTypeSupported` API.\n    if (MediaRecorder.isTypeSupported) {\n      const { restrictions } = this.uppy.opts\n      let preferredVideoMimeTypes = []\n      if (this.opts.preferredVideoMimeType) {\n        preferredVideoMimeTypes = [this.opts.preferredVideoMimeType]\n      } else if (restrictions.allowedFileTypes) {\n        preferredVideoMimeTypes = restrictions.allowedFileTypes.map(toMimeType).filter(isVideoMimeType)\n      }\n\n      const filterSupportedTypes = (candidateType) => MediaRecorder.isTypeSupported(candidateType)\n        && getFileTypeExtension(candidateType)\n      const acceptableMimeTypes = preferredVideoMimeTypes.filter(filterSupportedTypes)\n\n      if (acceptableMimeTypes.length > 0) {\n        // eslint-disable-next-line prefer-destructuring\n        options.mimeType = acceptableMimeTypes[0]\n      }\n    }\n\n    return options\n  }\n\n  startRecording () {\n    // only used if supportsMediaRecorder() returned true\n    // eslint-disable-next-line compat/compat\n    this.recorder = new MediaRecorder(this.stream, this.getMediaRecorderOptions())\n    this.recordingChunks = []\n    let stoppingBecauseOfMaxSize = false\n    this.recorder.addEventListener('dataavailable', (event) => {\n      this.recordingChunks.push(event.data)\n\n      const { restrictions } = this.uppy.opts\n      if (this.recordingChunks.length > 1\n          && restrictions.maxFileSize != null\n          && !stoppingBecauseOfMaxSize) {\n        const totalSize = this.recordingChunks.reduce((acc, chunk) => acc + chunk.size, 0)\n        // Exclude the initial chunk from the average size calculation because it is likely to be a very small outlier\n        const averageChunkSize = (totalSize - this.recordingChunks[0].size) / (this.recordingChunks.length - 1)\n        const expectedEndChunkSize = averageChunkSize * 3\n        const maxSize = Math.max(0, restrictions.maxFileSize - expectedEndChunkSize)\n\n        if (totalSize > maxSize) {\n          stoppingBecauseOfMaxSize = true\n          this.uppy.info(this.i18n('recordingStoppedMaxSize'), 'warning', 4000)\n          this.stopRecording()\n        }\n      }\n    })\n\n    // use a \"time slice\" of 500ms: ondataavailable will be called each 500ms\n    // smaller time slices mean we can more accurately check the max file size restriction\n    this.recorder.start(500)\n\n    if (this.opts.showRecordingLength) {\n      // Start the recordingLengthTimer if we are showing the recording length.\n      this.recordingLengthTimer = setInterval(() => {\n        const currentRecordingLength = this.getPluginState().recordingLengthSeconds\n        this.setPluginState({ recordingLengthSeconds: currentRecordingLength + 1 })\n      }, 1000)\n    }\n\n    this.setPluginState({\n      isRecording: true,\n    })\n  }\n\n  stopRecording () {\n    const stopped = new Promise((resolve) => {\n      this.recorder.addEventListener('stop', () => {\n        resolve()\n      })\n      this.recorder.stop()\n\n      if (this.opts.showRecordingLength) {\n        // Stop the recordingLengthTimer if we are showing the recording length.\n        clearInterval(this.recordingLengthTimer)\n        this.setPluginState({ recordingLengthSeconds: 0 })\n      }\n    })\n\n    return stopped.then(() => {\n      this.setPluginState({\n        isRecording: false,\n      })\n      return this.getVideo()\n    }).then((file) => {\n      try {\n        this.capturedMediaFile = file\n        // create object url for capture result preview\n        this.setPluginState({\n          // eslint-disable-next-line compat/compat\n          recordedVideo: URL.createObjectURL(file.data),\n        })\n        this.#enableMirror = false\n      } catch (err) {\n        // Logging the error, exept restrictions, which is handled in Core\n        if (!err.isRestriction) {\n          this.uppy.log(err)\n        }\n      }\n    }).then(() => {\n      this.recordingChunks = null\n      this.recorder = null\n    }, (error) => {\n      this.recordingChunks = null\n      this.recorder = null\n      throw error\n    })\n  }\n\n  discardRecordedVideo () {\n    this.setPluginState({ recordedVideo: null })\n\n    if (this.opts.mirror) {\n      this.#enableMirror = true\n    }\n\n    this.capturedMediaFile = null\n  }\n\n  submit () {\n    try {\n      if (this.capturedMediaFile) {\n        this.uppy.addFile(this.capturedMediaFile)\n      }\n    } catch (err) {\n      // Logging the error, exept restrictions, which is handled in Core\n      if (!err.isRestriction) {\n        this.uppy.log(err, 'error')\n      }\n    }\n  }\n\n  async stop () {\n    if (this.stream) {\n      const audioTracks = this.stream.getAudioTracks()\n      const videoTracks = this.stream.getVideoTracks()\n\n      audioTracks.concat(videoTracks).forEach((track) => track.stop())\n    }\n\n    if (this.recorder) {\n      await new Promise((resolve) => {\n        this.recorder.addEventListener('stop', resolve, { once: true })\n        this.recorder.stop()\n\n        if (this.opts.showRecordingLength) {\n          clearInterval(this.recordingLengthTimer)\n        }\n      })\n    }\n\n    this.recordingChunks = null\n    this.recorder = null\n    this.webcamActive = false\n    this.stream = null\n\n    this.setPluginState({\n      recordedVideo: null,\n      isRecording: false,\n      recordingLengthSeconds: 0,\n    })\n  }\n\n  getVideoElement () {\n    return this.el.querySelector('.uppy-Webcam-video')\n  }\n\n  oneTwoThreeSmile () {\n    return new Promise((resolve, reject) => {\n      let count = this.opts.countdown\n\n      // eslint-disable-next-line consistent-return\n      const countDown = setInterval(() => {\n        if (!this.webcamActive) {\n          clearInterval(countDown)\n          this.captureInProgress = false\n          return reject(new Error('Webcam is not active'))\n        }\n\n        if (count > 0) {\n          this.uppy.info(`${count}...`, 'warning', 800)\n          count--\n        } else {\n          clearInterval(countDown)\n          this.uppy.info(this.i18n('smile'), 'success', 1500)\n          setTimeout(() => resolve(), 1500)\n        }\n      }, 1000)\n    })\n  }\n\n  takeSnapshot () {\n    if (this.captureInProgress) return\n\n    this.captureInProgress = true\n\n    this.opts.onBeforeSnapshot().catch((err) => {\n      const message = typeof err === 'object' ? err.message : err\n      this.uppy.info(message, 'error', 5000)\n      return Promise.reject(new Error(`onBeforeSnapshot: ${message}`))\n    }).then(() => {\n      return this.getImage()\n    }).then((tagFile) => {\n      this.captureInProgress = false\n      try {\n        this.uppy.addFile(tagFile)\n      } catch (err) {\n        // Logging the error, except restrictions, which is handled in Core\n        if (!err.isRestriction) {\n          this.uppy.log(err)\n        }\n      }\n    }, (error) => {\n      this.captureInProgress = false\n      throw error\n    })\n  }\n\n  getImage () {\n    const video = this.getVideoElement()\n    if (!video) {\n      return Promise.reject(new Error('No video element found, likely due to the Webcam tab being closed.'))\n    }\n\n    const width = video.videoWidth\n    const height = video.videoHeight\n\n    const canvas = document.createElement('canvas')\n    canvas.width = width\n    canvas.height = height\n    const ctx = canvas.getContext('2d')\n    ctx.drawImage(video, 0, 0)\n\n    const { restrictions } = this.uppy.opts\n    let preferredImageMimeTypes = []\n    if (this.opts.preferredImageMimeType) {\n      preferredImageMimeTypes = [this.opts.preferredImageMimeType]\n    } else if (restrictions.allowedFileTypes) {\n      preferredImageMimeTypes = restrictions.allowedFileTypes.map(toMimeType).filter(isImageMimeType)\n    }\n\n    const mimeType = preferredImageMimeTypes[0] || 'image/jpeg'\n    const ext = getFileTypeExtension(mimeType) || 'jpg'\n    const name = `cam-${Date.now()}.${ext}`\n\n    return canvasToBlob(canvas, mimeType).then((blob) => {\n      return {\n        source: this.id,\n        name,\n        data: new Blob([blob], { type: mimeType }),\n        type: mimeType,\n      }\n    })\n  }\n\n  getVideo () {\n    // Sometimes in iOS Safari, Blobs (especially the first Blob in the recordingChunks Array)\n    // have empty 'type' attributes (e.g. '') so we need to find a Blob that has a defined 'type'\n    // attribute in order to determine the correct MIME type.\n    const mimeType = this.recordingChunks.find(blob => blob.type?.length > 0).type\n\n    const fileExtension = getFileTypeExtension(mimeType)\n\n    if (!fileExtension) {\n      return Promise.reject(new Error(`Could not retrieve recording: Unsupported media type \"${mimeType}\"`))\n    }\n\n    const name = `webcam-${Date.now()}.${fileExtension}`\n    const blob = new Blob(this.recordingChunks, { type: mimeType })\n    const file = {\n      source: this.id,\n      name,\n      data: new Blob([blob], { type: mimeType }),\n      type: mimeType,\n    }\n\n    return Promise.resolve(file)\n  }\n\n  focus () {\n    if (!this.opts.countdown) return\n    setTimeout(() => {\n      this.uppy.info(this.i18n('smile'), 'success', 1500)\n    }, 1000)\n  }\n\n  changeVideoSource (deviceId) {\n    this.stop()\n    this.start({ deviceId })\n  }\n\n  updateVideoSources () {\n    this.mediaDevices.enumerateDevices().then(devices => {\n      this.setPluginState({\n        videoSources: devices.filter((device) => device.kind === 'videoinput'),\n      })\n    })\n  }\n\n  render () {\n    if (!this.webcamActive) {\n      this.start()\n    }\n\n    const webcamState = this.getPluginState()\n\n    if (!webcamState.cameraReady || !webcamState.hasCamera) {\n      return (\n        <PermissionsScreen\n          icon={CameraIcon}\n          i18n={this.i18n}\n          hasCamera={webcamState.hasCamera}\n        />\n      )\n    }\n\n    return (\n      <CameraScreen\n        // eslint-disable-next-line react/jsx-props-no-spreading\n        {...webcamState}\n        onChangeVideoSource={this.changeVideoSource}\n        onSnapshot={this.takeSnapshot}\n        onStartRecording={this.startRecording}\n        onStopRecording={this.stopRecording}\n        onDiscardRecordedVideo={this.discardRecordedVideo}\n        onSubmit={this.submit}\n        onFocus={this.focus}\n        onStop={this.stop}\n        i18n={this.i18n}\n        modes={this.opts.modes}\n        showRecordingLength={this.opts.showRecordingLength}\n        showVideoSourceDropdown={this.opts.showVideoSourceDropdown}\n        supportsRecording={supportsMediaRecorder()}\n        recording={webcamState.isRecording}\n        mirror={this.#enableMirror}\n        src={this.stream}\n      />\n    )\n  }\n\n  install () {\n    this.setPluginState({\n      cameraReady: false,\n      recordingLengthSeconds: 0,\n    })\n\n    const { target } = this.opts\n    if (target) {\n      this.mount(target, this)\n    }\n\n    if (this.mediaDevices) {\n      this.updateVideoSources()\n\n      this.mediaDevices.ondevicechange = () => {\n        this.updateVideoSources()\n\n        if (this.stream) {\n          let restartStream = true\n\n          const { videoSources, currentDeviceId } = this.getPluginState()\n\n          videoSources.forEach((videoSource) => {\n            if (currentDeviceId === videoSource.deviceId) {\n              restartStream = false\n            }\n          })\n\n          if (restartStream) {\n            this.stop()\n            this.start()\n          }\n        }\n      }\n    }\n  }\n\n  uninstall () {\n    this.stop()\n    this.unmount()\n  }\n\n  onUnmount () {\n    this.stop()\n  }\n}\n"]}